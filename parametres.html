<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Paramètres - Gestion Pressing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script>
      async function changePassword(e) {
        e.preventDefault()
        const form = e.target
        const inputs = form.querySelectorAll('input[type="password"]')
        const password = inputs[0].value
        const confirm = inputs[1].value

        if (!password || !confirm) {
          alert('Veuillez remplir les deux champs.')
          return
        }
        if (password !== confirm) {
          alert('Les mots de passe ne correspondent pas.')
          return
        }

        // Appel à l’API pour changer le mot de passe
        const result = await window.api.changePassword(password)
        if (result && result.success) {
          alert('Mot de passe modifié avec succès.')
          form.reset()
        } else {
          alert(
            result && result.error
              ? result.error
              : 'Erreur lors du changement de mot de passe.'
          )
        }
      }

      function navigate(page) {
        window.api.navigate(page)
      }
      function saveSettings(e) {
        e.preventDefault()
        alert('Paramètres enregistrés (simulation)')
      }

      // Affichage conditionnel pour l'admin
      document.addEventListener('DOMContentLoaded', () => {
        const role = localStorage.getItem('role')
        if (role !== 'admin') {
          document.getElementById('user-management').style.display = 'none'
        } else {
          loadUsers()
        }
      })

      // Charger la liste des utilisateurs
      async function loadUsers() {
        const users = await window.api.getUsers()
        const tbody = document.getElementById('usersTable')
        tbody.innerHTML = ''
        users.forEach(user => {
          tbody.innerHTML += `
        <tr>
          <td class="px-2 py-1">${user.username}</td>
          <td class="px-2 py-1">${user.role}</td>
          <td class="px-2 py-1">
            <button onclick="deleteUser('${user.username}')" class="text-red-600 mr-2">Supprimer</button>
            <button onclick="showUpdateUser('${user.username}', '${user.role}')" class="text-blue-600">Modifier</button>
          </td>
        </tr>
      `
        })
      }

      // Ajouter un utilisateur
      async function addUser(e) {
        e.preventDefault()
        const username = document.getElementById('newUsername').value
        const password = document.getElementById('newPassword').value
        const role = document.getElementById('newRole').value
        const result = await window.api.addUser(username, password, role)
        if (result.success) {
          loadUsers()
          e.target.reset()
        } else {
          alert(result.error)
        }
      }

      // Supprimer un utilisateur
      async function deleteUser(username) {
        if (!confirm('Supprimer cet utilisateur ?')) return
        const result = await window.api.deleteUser(username)
        if (result.success) {
          loadUsers()
        } else {
          alert(result.error)
        }
      }

      // Afficher le formulaire de modification
      function showUpdateUser(username, role) {
        const newRole = prompt(
          'Nouveau rôle pour ' + username + ' (admin/employe):',
          role
        )
        if (newRole && (newRole === 'admin' || newRole === 'employe')) {
          updateUser(username, newRole)
        }
      }

      // Modifier le rôle d'un utilisateur
      async function updateUser(username, role) {
        const result = await window.api.updateUser(username, role)
        if (result.success) {
          loadUsers()
        } else {
          alert(result.error)
        }
      }
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="flex">
      <!-- Sidebar -->
      <aside
        class="w-56 bg-gray-800 text-gray-200 min-h-screen flex flex-col pt-8 fixed"
      >
        <div class="text-center mb-8">
          <h2 class="text-xl font-bold text-white">
            <i class="fa fa-tshirt mr-2"></i>Pressing
          </h2>
        </div>
        <ul class="flex-1 space-y-2">
          <li>
            <a
              href="#"
              onclick="navigate('dashboard')"
              class="flex items-center px-6 py-3 hover:bg-gray-700 rounded-l-full"
            >
              <i class="fa fa-home mr-3"></i> Tableau de bord
            </a>
          </li>
          <li>
            <a
              href="#"
              onclick="navigate('clients')"
              class="flex items-center px-6 py-3 hover:bg-gray-700 rounded-l-full"
            >
              <i class="fa fa-users mr-3"></i> Clients
            </a>
          </li>
          <li>
            <a
              href="#"
              onclick="navigate('commandes')"
              class="flex items-center px-6 py-3 hover:bg-gray-700 rounded-l-full"
            >
              <i class="fa fa-shopping-basket mr-3"></i> Commandes
            </a>
          </li>
          <li>
            <a
              href="#"
              onclick="navigate('articles')"
              class="flex items-center px-6 py-3 hover:bg-gray-700 rounded-l-full"
            >
              <i class="fa fa-tasks mr-3"></i> Articles
            </a>
          </li>
          <li class="bg-gray-900 rounded-l-full">
            <a
              href="#"
              onclick="navigate('parametres')"
              class="flex items-center px-6 py-3 font-semibold text-white"
            >
              <i class="fa fa-cogs mr-3"></i> Paramètres
            </a>
          </li>
        </ul>
      </aside>
      <!-- Main content -->
      <div class="flex-1 ml-56">
        <!-- Header -->
        <header
          class="h-16 bg-blue-600 flex items-center px-8 shadow text-white fixed w-full z-10"
          style="left: 14rem"
        >
          <span class="text-lg font-semibold"
            >Paramètres - Gestion du Pressing</span
          >
        </header>
        <!-- Content -->
        <main class="pt-24 px-8">
          <div class="max-w-xl mx-auto bg-white rounded-lg shadow p-8">
            <h2 class="text-2xl font-bold text-blue-600 mb-6 flex items-center">
              <i class="fa fa-cogs mr-2"></i> Paramètres du pressing
            </h2>
            <form onsubmit="saveSettings(event)" class="space-y-4 mb-8">
              <div>
                <label class="block text-gray-700 mb-1">Nom du pressing</label>
                <input
                  type="text"
                  class="w-full border rounded px-3 py-2"
                  value="Pressing Demo"
                  required
                />
              </div>
              <div>
                <label class="block text-gray-700 mb-1">Adresse</label>
                <input
                  type="text"
                  class="w-full border rounded px-3 py-2"
                  value="123 rue de Paris"
                  required
                />
              </div>
              <div>
                <label class="block text-gray-700 mb-1">Téléphone</label>
                <input
                  type="text"
                  class="w-full border rounded px-3 py-2"
                  value="01 23 45 67 89"
                  required
                />
              </div>
              <div>
                <label class="block text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  class="w-full border rounded px-3 py-2"
                  value="contact@pressing.com"
                  required
                />
              </div>
              <div class="flex justify-end">
                <button
                  type="submit"
                  class="px-6 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                >
                  Sauvegarder
                </button>
              </div>
            </form>
            <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
              <i class="fa fa-lock mr-2"></i> Sécurité
            </h3>
            <form onsubmit="changePassword(event)" class="space-y-4">
              <div>
                <label class="block text-gray-700 mb-1"
                  >Nouveau mot de passe</label
                >
                <input
                  type="password"
                  class="w-full border rounded px-3 py-2"
                  required
                />
              </div>
              <div>
                <label class="block text-gray-700 mb-1"
                  >Confirmer le mot de passe</label
                >
                <input
                  type="password"
                  class="w-full border rounded px-3 py-2"
                  required
                />
              </div>
              <div class="flex justify-end">
                <button
                  type="submit"
                  class="px-6 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                >
                  Changer le mot de passe
                </button>
              </div>
            </form>
          </div>
        </main>
      </div>
      <!-- Operate user -->
      <!-- Gestion des utilisateurs (visible uniquement pour l'admin) -->
      <main class="pt-24 px-8">
        <div id="user-management" class="mt-10 bg-white rounded-lg shadow p-8">
          <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
            <i class="fa fa-users-cog mr-2"></i> Gestion des utilisateurs
          </h3>
          <form
            id="addUserForm"
            class="flex gap-2 mb-4"
            onsubmit="addUser(event)"
          >
            <input
              type="text"
              id="newUsername"
              placeholder="Nom d'utilisateur"
              class="border rounded px-2 py-1"
              required
            />
            <input
              type="password"
              id="newPassword"
              placeholder="Mot de passe"
              class="border rounded px-2 py-1"
              required
            />
            <select id="newRole" class="border rounded px-2 py-1">
              <option value="employe">Employé</option>
              <option value="admin">Admin</option>
            </select>
            <button type="submit" class="bg-blue-600 text-white px-4 rounded">
              Ajouter
            </button>
          </form>
          <table class="min-w-full table-auto">
            <thead>
              <tr>
                <th class="px-2 py-1">Nom</th>
                <th class="px-2 py-1">Rôle</th>
                <th class="px-2 py-1">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
        </div>
      </main>
    </div>
  </body>
</html>
